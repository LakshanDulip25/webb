<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Money Saving Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* General Styles */
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      /* Base gradient */
      background: linear-gradient(135deg, #001f3f, #003366);
      /* Star layers */
      background-image:
        linear-gradient(135deg, #001f3f, #003366), /* Keep original gradient as top layer */
        radial-gradient(circle, #ffffff 1px, transparent 1px), /* Small stars */
        radial-gradient(circle, #ffffff 1px, transparent 1px); /* More small stars */
      background-size:
        100% 100%, /* Gradient size */
        200px 200px, /* Small stars density */
        300px 300px; /* Slightly different density for variation */
      background-position:
        0 0, /* Gradient position */
        0 0, /* Small stars start */
        150px 150px; /* Offset second star layer */
      background-repeat:
        no-repeat, /* Gradient doesn't repeat */
        repeat, /* Stars repeat */
        repeat; /* Stars repeat */
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden; /* Crucial to prevent scrollbars from animation */
      padding: 40px 20px;
      animation: moveStars 200s linear infinite; /* Apply animation */
    }

    /* Keyframes for star movement */
    @keyframes moveStars {
      from {
        background-position: 0 0, 0 0, 150px 150px;
      }
      to {
        /* Move layers at different speeds for parallax */
        background-position: 0 0, -10000px 5000px, -12000px 6000px;
      }
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 30px;
      text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.5);
      background: linear-gradient(90deg, #64ffda, #48d1cc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 1px;
      animation: fadeInDown 1.2s ease-out;
    }

    /* Input Card Styles */
    form {
      background: rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 450px;
      backdrop-filter: blur(12px);
      animation: slideInUp 1s ease-out;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.18);
      transform-style: preserve-3d;
      perspective: 1000px;
      transition: transform 0.3s ease;
    }

    form:hover {
      transform: translateY(-5px) rotateX(2deg);
    }

    input[type="text"],
    input[type="number"] {
      margin: 15px 0;
      padding: 16px 20px;
      border: none;
      border-radius: 12px;
      width: calc(100% - 40px);
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      background-color: rgba(255, 255, 255, 0.9);
      color: #001f3f;
      font-weight: 500;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      outline: 2px solid transparent;
    }

    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: 2px solid #64ffda;
      transform: scale(1.02);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    }

    /* File Input Styling */
    .file-input-container {
      position: relative;
      margin: 15px 0;
      overflow: hidden;
    }

    .file-input-label {
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.9);
      color: #001f3f;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      font-weight: 500;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .file-input-label:before {
      content: "📸";
      margin-right: 10px;
      font-size: 1.2rem;
    }

    .file-input-label:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      background-color: rgba(255, 255, 255, 0.95);
    }

    input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-name {
      margin-top: 8px;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.9);
      text-align: center;
      font-style: italic;
      transition: color 0.3s ease;
    }

    /* Submit Button Styles */
    button[type="submit"] {
      background: linear-gradient(135deg, #00c853, #64dd17);
      color: white;
      font-weight: 600;
      cursor: pointer;
      padding: 16px;
      border: none;
      border-radius: 12px;
      width: 100%;
      font-size: 1.1rem;
      letter-spacing: 1px;
      box-shadow: 0 4px 15px rgba(0, 200, 83, 0.4);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      opacity: 0.5;
      pointer-events: none;
      margin-top: 10px;
      overflow: hidden;
      position: relative;
      font-family: 'Poppins', sans-serif;
    }

    button[type="submit"].enabled {
      opacity: 1;
      pointer-events: auto;
    }

    button[type="submit"].enabled:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 20px rgba(0, 200, 83, 0.5);
    }

    button[type="submit"].enabled:active {
      transform: translateY(1px);
    }

    button[type="submit"]:after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }

    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(100, 100);
        opacity: 0;
      }
    }

    button[type="submit"].enabled:focus:not(:active)::after {
      animation: ripple 1s ease-out;
    }

    /* Total Amount Section */
    .total-amount {
      margin: 30px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(12px);
      font-size: 1.4rem;
      text-align: center;
      width: 90%;
      max-width: 450px;
      animation: pulse 2s infinite alternate;
      border: 1px solid rgba(255, 255, 255, 0.18);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .total-amount strong {
      color: #64ffda;
      font-weight: 700;
      font-size: 1.6rem;
    }

    /* Container for download buttons */
    .download-buttons-container {
        display: flex;
        flex-direction: column; /* Stack buttons vertically by default */
        gap: 10px; /* Space between buttons */
        width: 90%;
        max-width: 450px;
        margin: 20px auto 0 auto; /* Centered below total */
    }

    /* General Download Button Style */
    .download-button {
      color: white;
      font-weight: 600;
      cursor: pointer;
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      letter-spacing: 0.5px;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      width: 100%; /* Full width within container */
      text-align: center;
      font-family: 'Poppins', sans-serif;
      text-decoration: none;
    }

    /* Specific PDF Button Style */
     .download-button.pdf {
         background: linear-gradient(135deg, #1e88e5, #0d47a1); /* Blue gradient */
         box-shadow: 0 4px 15px rgba(30, 136, 229, 0.4);
     }
     .download-button.pdf:hover:not(:disabled) {
         transform: translateY(-3px) scale(1.02);
         box-shadow: 0 8px 20px rgba(30, 136, 229, 0.5);
     }

    /* Specific CSV Button Style */
     .download-button.csv {
         background: linear-gradient(135deg, #43a047, #1b5e20); /* Green gradient */
         box-shadow: 0 4px 15px rgba(67, 160, 71, 0.4);
     }
    .download-button.csv:hover:not(:disabled) {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 20px rgba(67, 160, 71, 0.5);
    }

    .download-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background: #999; /* Darker gray when disabled */
         box-shadow: none;
         transform: none;
    }

    /* History Section */
    .history {
      margin-top: 40px;
      width: 90%;
      max-width: 650px;
      animation: fadeIn 1.2s ease-out;
    }

    .history h2 {
      font-size: 1.8rem;
      margin-bottom: 25px;
      text-align: center;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      position: relative;
      display: inline-block;
      left: 50%;
      transform: translateX(-50%);
    }

    .history h2:after {
      content: '';
      position: absolute;
      width: 50%;
      height: 3px;
      background: linear-gradient(90deg, transparent, #64ffda, transparent);
      bottom: -8px;
      left: 25%;
    }

    .entry-card {
      background: rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.18);
      transform: translateY(0);
      transition: opacity 0.5s ease, transform 0.5s ease; /* Added opacity transition */
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }

    .entry-card-info {
      flex: 1;
      min-width: 60%;
      padding-right: 15px; /* Add some spacing */
    }

    .entry-card img {
      max-width: 100px;
      max-height: 100px; /* Ensure consistency */
      border-radius: 8px;
      margin-top: 10px; /* Add margin if wrapping */
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      object-fit: cover; /* Crop image to fit */
      height: auto; /* Allow height to adjust */
      flex-shrink: 0; /* Prevent image from shrinking */
    }

    .no-image-placeholder {
        font-style: italic;
        color: #ccc;
        font-size: 0.9em;
        margin: auto 0; /* Vertically center */
        text-align: center;
        flex-basis: 100px; /* Approx width of image */
        padding: 10px 0; /* Add some padding */
        align-self: center; /* Align with text block */
    }

    .entry-card img:hover {
      transform: scale(1.1);
    }

    .entry-card p {
      margin: 6px 0; /* Slightly reduced margin */
      font-size: 0.95rem; /* Slightly smaller font */
      word-break: break-word; /* Prevent long words from overflowing */
    }

    .entry-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
    }

    /* Table Section */
    table {
      margin-top: 40px;
      width: 90%;
      max-width: 650px;
      border-collapse: separate;
      border-spacing: 0;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(12px);
      animation: fadeIn 1.2s ease-out;
      margin-bottom: 50px;
    }

    table th,
    table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      word-break: break-word; /* Prevent long names/amounts breaking layout */
    }

    table th {
      background: rgba(255, 255, 255, 0.2);
      font-weight: 600;
      letter-spacing: 1px;
      position: sticky; /* Make header sticky */
      top: 0; /* Stick to top */
      z-index: 1; /* Ensure header is above rows */
    }

    table th:after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(100, 255, 218, 0.5), transparent);
    }

    table tr:last-child td {
      border-bottom: none;
    }

    table tr {
      transition: background-color 0.3s ease;
    }

    table tr:hover td {
      background-color: rgba(255, 255, 255, 0.05);
    }

    table td:first-child {
      font-weight: 500;
      text-transform: capitalize; /* Capitalize name in table */
    }

    table td:last-child {
      font-weight: 600;
      color: #64ffda;
    }

    /* Suggestions Dropdown */
    .suggestions {
      position: absolute;
      top: calc(100% - 10px); /* Position slightly below input */
      left: 0;
      width: 100%;
      max-height: 150px;
      overflow-y: auto;
      background: rgba(255, 255, 255, 0.98); /* More opaque */
      border-radius: 0 0 12px 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* Stronger shadow */
      z-index: 10;
      display: none;
      scrollbar-width: thin; /* For Firefox */
      scrollbar-color: #64ffda #001f3f; /* For Firefox */
    }
    /* Webkit scrollbar styling */
    .suggestions::-webkit-scrollbar {
        width: 8px;
    }
    .suggestions::-webkit-scrollbar-track {
        background: rgba(0, 31, 63, 0.5);
        border-radius: 10px;
    }
    .suggestions::-webkit-scrollbar-thumb {
        background-color: #64ffda;
        border-radius: 10px;
        border: 2px solid rgba(0, 31, 63, 0.5);
    }

    .suggestions div {
      padding: 12px 20px; /* More padding */
      cursor: pointer;
      transition: all 0.2s ease;
      color: #001f3f;
      font-weight: 500;
      border-bottom: 1px solid rgba(0, 31, 63, 0.1); /* Subtle divider */
      text-transform: capitalize; /* Capitalize suggestions */
    }
     .suggestions div:last-child {
         border-bottom: none;
     }

    .suggestions div:hover {
      background: rgba(100, 255, 218, 0.2); /* Highlight color */
    }

    /* Footer Styles */
    .footer {
      margin-top: 20px;
      margin-bottom: 30px;
      text-align: center;
      font-size: 1.2rem;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 15px 25px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      animation: fadeIn 1.5s ease-out;
    }

    .footer a {
      color: #64ffda;
      text-decoration: none;
      position: relative;
      transition: all 0.3s ease;
    }

    .footer a:hover {
      text-shadow: 0 0 10px rgba(100, 255, 218, 0.6);
    }

    .footer a::after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: -3px;
      left: 0;
      background: linear-gradient(90deg, #64ffda, #48d1cc);
      transition: width 0.3s ease;
    }

    .footer a:hover::after {
      width: 100%;
    }

    /* Enhanced Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      from {
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }
      to {
        box-shadow: 0 8px 32px rgba(100, 255, 218, 0.3);
      }
    }

    /* Responsive Design */
    @media (max-width: 600px) {
      body {
          padding: 20px 10px; /* Reduce padding on small screens */
      }
      h1 {
        font-size: 1.8rem;
      }
      form {
        padding: 20px;
      }
      button[type="submit"] {
        font-size: 1rem;
      }
      .download-button {
          font-size: 0.9rem;
          padding: 10px 15px;
      }
      .history h2 {
        font-size: 1.5rem;
      }
       .entry-card {
           padding: 15px;
       }
        .entry-card img {
            max-width: 80px;
            max-height: 80px; /* Match max-width */
        }
       .entry-card p {
           font-size: 0.9rem;
       }
      table {
        font-size: 0.9rem;
      }
       table th, table td {
           padding: 12px;
       }
      .total-amount {
        font-size: 1.2rem;
        padding: 15px;
      }
      .total-amount strong {
        font-size: 1.4rem;
      }
      .footer {
        font-size: 1rem;
        padding: 10px 15px;
      }
    }
     @media (min-width: 481px) { /* Side-by-side download buttons on slightly larger screens */
        .download-buttons-container {
            flex-direction: row; /* Side-by-side */
        }
        .entry-card img {
             margin-top: 0; /* Remove top margin on larger screens where image likely won't wrap */
         }
    }

  </style>
</head>
<body>
  <h1>Money Saving Tracker</h1>

  <form id="trackerForm">
    <div style="position: relative;">
      <input type="text" id="name" placeholder="Enter Name" required autocomplete="off" />
      <div class="suggestions" id="nameSuggestions"></div>
    </div>

    <div class="file-input-container">
      <label for="receiptImage" class="file-input-label">Choose Receipt Image</label>
      <input type="file" id="receiptImage" accept="image/*" required />
      <div class="file-name" id="fileName">No file chosen</div>
    </div>

    <input type="number" id="amount" placeholder="Enter Amount (LKR)" required step="0.01" min="0"/>
    <button type="submit" id="submitButton">Submit</button>
  </form>

  <div class="total-amount" id="totalAmount">
    Total Amount Saved: <strong>LKR 0.00</strong>
  </div>

  <div class="download-buttons-container">
      <button id="downloadPdfButton" class="download-button pdf" disabled>Download Report (PDF)</button>
      <button id="downloadCsvButton" class="download-button csv" disabled>Download Data (CSV)</button>
  </div>

  <div class="history">
    <h2>History</h2>
    <div id="historyList">
        </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Total Savings (LKR)</th>
      </tr>
    </thead>
    <tbody id="summaryTable">
      <tr><td colspan="2" style="text-align: center; font-style: italic; color: #ccc;">Loading data...</td></tr>
    </tbody>
  </table>

<div class="footer">
     Current time in Sri Lanka: <span id="currentTime">Loading...</span><br>
    <a href="https://t.me/MrLAXAN" target="_blank">𝐃𝐞𝐯𝐞𝐥𝐨𝐩𝐞𝐝 𝐛𝐲 𝐋𝐚𝐤𝐬𝐡𝐚𝐧 🚀💻🔥</a>
  </div>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js";

    // Your Firebase configuration (Replace with your actual config)
    const firebaseConfig = {
     apiKey: "AIzaSyD1DbAbZ8yLeJxULV2giceFwzRFM6I-FF0", // Replace with your key
     authDomain: "websavelxn.firebaseapp.com",          // Replace with your domain
     databaseURL: "https://websavelxn-default-rtdb.firebaseio.com", // Replace with your URL
     projectId: "websavelxn",                         // Replace with your project ID
     storageBucket: "websavelxn.firebasestorage.app",   // Replace with your bucket
     messagingSenderId: "781394117165",                // Replace with your sender ID
     appId: "1:781394117165:web:cf042f7d5de2776222eea4" // Replace with your app ID
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // ImgBB API Key (Replace with your actual key)
    const IMGBB_API_KEY = "c59fd4d2f34bb26b393faaf7affe501f"; // Replace with your key

    // DOM Elements
    const trackerForm = document.getElementById("trackerForm");
    const historyList = document.getElementById("historyList");
    const submitButton = document.getElementById("submitButton");
    const totalAmountDisplay = document.getElementById("totalAmount");
    const summaryTable = document.getElementById("summaryTable");
    const nameInput = document.getElementById("name");
    const nameSuggestions = document.getElementById("nameSuggestions");
    const receiptImageInput = document.getElementById("receiptImage");
    const fileNameDisplay = document.getElementById("fileName");
    const downloadPdfButton = document.getElementById("downloadPdfButton");
    const downloadCsvButton = document.getElementById("downloadCsvButton");
    const currentTimeDisplay = document.getElementById("currentTime");


    let totalAmount = 0; // Track total amount
    const previousNames = new Set(); // Store unique names for suggestions

    // --- START: Data Storage for Downloads ---
    let allEntriesData = {}; // For PDF (grouped by name)
    let allSummaryData = {}; // For PDF (summary totals)
    let allRawEntries = [];  // For CSV (flat list of all entries)
    // --- END: Data Storage for Downloads ---

    // --- START: Current Time Display ---
     function updateCurrentTime() {
        const now = new Date();
        const options = {
            timeZone: 'Asia/Colombo', // Sri Lanka Time Zone
            year: 'numeric', month: 'long', day: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
        };
         try {
             currentTimeDisplay.textContent = now.toLocaleString('en-US', options);
         } catch (e) {
             console.error("Error formatting time:", e);
             currentTimeDisplay.textContent = "Error loading time";
         }
    }
    updateCurrentTime(); // Initial call
    setInterval(updateCurrentTime, 1000); // Update every second
    // --- END: Current Time Display ---

    // Update file name display when a file is selected
    receiptImageInput.addEventListener("change", function() {
      if (this.files && this.files[0]) {
        fileNameDisplay.textContent = this.files[0].name;
        fileNameDisplay.style.color = "#64ffda";
      } else {
        fileNameDisplay.textContent = "No file chosen";
        fileNameDisplay.style.color = "rgba(255, 255, 255, 0.9)";
      }
      checkFormValidity();
    });

    // Function to upload image to ImgBB
    async function uploadImage(file) {
      const formData = new FormData();
      formData.append("image", file);
      formData.append("key", IMGBB_API_KEY);
      try {
        const response = await fetch("https://api.imgbb.com/1/upload", { method: "POST", body: formData });
        const data = await response.json();
        if (!data.success) { throw new Error("ImgBB upload failed: " + (data.error?.message || data.status_code || "Unknown error")); }
        return data.data.url;
      } catch (error) {
        console.error("ImgBB Fetch/Upload Error:", error);
        alert(`Image upload failed: ${error.message}. Please try again or check the ImgBB key.`);
        throw error;
      }
    }

    // Function to save entry to Firebase Realtime Database
    function saveEntry(name, imageUrl, amount) {
      const timestamp = Date.now();
      const entryPath = `entries/${timestamp}`;
      const entryRef = ref(database, entryPath);
      set(entryRef, { name: name.trim().toLowerCase(), imageUrl, amount: parseFloat(amount), timestamp })
        .catch(error => { console.error("Firebase save error:", error); alert("Failed to save data."); });
    }

    // Function to load history from Firebase Realtime Database
    function loadHistory() {
      const entriesRef = ref(database, "entries");
      onValue(entriesRef, (snapshot) => {
        historyList.innerHTML = "";
        const entries = snapshot.val();
        totalAmount = 0; const summaryData = {}; const entriesGroupedByName = {}; let rawEntriesList = [];
        previousNames.clear();

        if (entries) {
          const sortedEntries = Object.values(entries)
             .filter(entry => entry && typeof entry.name === 'string' && typeof entry.timestamp === 'number' && typeof entry.amount === 'number')
             .sort((a, b) => b.timestamp - a.timestamp);
           rawEntriesList = [...sortedEntries];
           sortedEntries.forEach((entry) => {
               const amountValue = parseFloat(entry.amount) || 0; totalAmount += amountValue; addEntryToHistory(entry);
               const name = entry.name.trim().toLowerCase(); previousNames.add(name);
               if (!summaryData[name]) { summaryData[name] = 0; entriesGroupedByName[name] = []; }
               summaryData[name] += amountValue; entriesGroupedByName[name].push({ amount: amountValue, timestamp: entry.timestamp, imageUrl: entry.imageUrl || null });
            });
            for(const name in entriesGroupedByName) { entriesGroupedByName[name].sort((a, b) => b.timestamp - a.timestamp); }
        } else { historyList.innerHTML = '<p style="text-align: center; font-style: italic; color: #ccc;">No history entries found.</p>'; }

        allEntriesData = entriesGroupedByName; allSummaryData = summaryData; allRawEntries = rawEntriesList;
        totalAmountDisplay.innerHTML = `Total Amount Saved: <strong>LKR ${totalAmount.toFixed(2)}</strong>`;
        updateSummaryTable(summaryData);
        const hasData = allRawEntries.length > 0; downloadPdfButton.disabled = !hasData; downloadCsvButton.disabled = !hasData;
      }, (error) => {
        console.error("Firebase read error:", error); alert("Could not load data from the database.");
         allEntriesData = {}; allSummaryData = {}; allRawEntries = []; totalAmountDisplay.innerHTML = `Total Amount Saved: <strong>LKR 0.00</strong>`;
         updateSummaryTable({}); historyList.innerHTML = '<p style="text-align: center; font-style: italic; color: #f00;">Error loading history.</p>';
         downloadPdfButton.disabled = true; downloadCsvButton.disabled = true;
      });
    }

    // Function to add an entry to the history section with animation
    function addEntryToHistory(entry) {
      const entryCard = document.createElement("div"); entryCard.classList.add("entry-card");
      const entryDate = new Date(entry.timestamp).toLocaleString('en-LK', { timeZone: 'Asia/Colombo' });
      const entryAmount = (parseFloat(entry.amount) || 0).toFixed(2);
      const displayName = entry.name.charAt(0).toUpperCase() + entry.name.slice(1);
      const imageHtml = entry.imageUrl ? `<img src="${entry.imageUrl}" alt="Receipt" loading="lazy" />` : '<p class="no-image-placeholder">(No Image)</p>';
      entryCard.innerHTML = `<div class="entry-card-info"><p><strong>Name:</strong> ${displayName}</p><p><strong>Amount:</strong> LKR ${entryAmount}</p><p><strong>Date:</strong> ${entryDate}</p></div>${imageHtml}`;
      historyList.prepend(entryCard); // Prepend to show newest first
      requestAnimationFrame(() => { entryCard.style.opacity = "0"; entryCard.style.transform = "translateY(-20px)"; requestAnimationFrame(() => { entryCard.style.opacity = "1"; entryCard.style.transform = "translateY(0)"; }); });
    }

    // Function to update the summary table
    function updateSummaryTable(summaryData) {
      summaryTable.innerHTML = "";
      const sortedNames = Object.keys(summaryData).sort();
       if (sortedNames.length === 0) {
           summaryTable.innerHTML = `<tr><td colspan="2" style="text-align: center; font-style: italic; color: #ccc;">No summary data available.</td></tr>`;
       } else {
          sortedNames.forEach(name => {
            const total = summaryData[name]; const row = document.createElement("tr");
            const displayName = name.charAt(0).toUpperCase() + name.slice(1);
            row.innerHTML = `<td>${displayName}</td><td>LKR ${total.toFixed(2)}</td>`;
            summaryTable.appendChild(row);
          });
       }
    }

    // Function to check if all required form fields are valid
    function checkFormValidity() {
        const name = nameInput.value.trim(); const receiptImage = receiptImageInput.files[0]; const amount = document.getElementById("amount").value.trim();
        const isValidAmount = amount && !isNaN(parseFloat(amount)) && parseFloat(amount) >= 0;
        const isValidName = name && !/\d/.test(name);
        submitButton.classList.toggle('enabled', isValidName && receiptImage && isValidAmount);
    }

    // Event Listener for Form Submission
    trackerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!submitButton.classList.contains('enabled')) { return; }
      const name = nameInput.value.trim(); const receiptImage = receiptImageInput.files[0]; const amount = document.getElementById("amount").value.trim();
       if (!name || /\d/.test(name) || !receiptImage || !amount || isNaN(parseFloat(amount)) || parseFloat(amount) < 0) { alert("Please ensure all fields are correctly filled."); return; }
      submitButton.innerHTML = "Saving..."; submitButton.disabled = true; submitButton.classList.remove('enabled');
      try {
        const imageUrl = await uploadImage(receiptImage); saveEntry(name, imageUrl, amount);
        setTimeout(() => { submitButton.innerHTML = "Submit"; submitButton.disabled = false; checkFormValidity(); }, 500);
        trackerForm.reset(); fileNameDisplay.textContent = "No file chosen"; fileNameDisplay.style.color = "rgba(255, 255, 255, 0.9)"; nameSuggestions.style.display = 'none';
      } catch (error) { submitButton.innerHTML = "Submit"; submitButton.disabled = false; checkFormValidity(); }
    });

    // Enable Submit Button Only When All Fields Are Valid
    trackerForm.addEventListener("input", checkFormValidity);

    // --- Suggestions Dropdown Logic ---
    nameInput.addEventListener("input", () => {
        const inputText = nameInput.value.trim().toLowerCase(); nameSuggestions.innerHTML = "";
        if (inputText.length > 0 && previousNames.size > 0) {
            const filteredNames = Array.from(previousNames).filter(name => name.toLowerCase().includes(inputText)).sort();
             if (filteredNames.length > 0) {
                nameSuggestions.style.display = "block";
                filteredNames.forEach((name) => {
                    const suggestionDiv = document.createElement("div"); suggestionDiv.textContent = name.charAt(0).toUpperCase() + name.slice(1);
                    suggestionDiv.addEventListener("click", () => { nameInput.value = name.charAt(0).toUpperCase() + name.slice(1); nameSuggestions.style.display = "none"; checkFormValidity(); nameInput.focus(); });
                    nameSuggestions.appendChild(suggestionDiv);
                });
             } else { nameSuggestions.style.display = "none"; }
        } else { nameSuggestions.style.display = "none"; }
    });
     nameInput.addEventListener("focus", () => {
        const inputText = nameInput.value.trim().toLowerCase();
        if (inputText.length === 0 && previousNames.size > 0) {
             nameSuggestions.innerHTML = ""; nameSuggestions.style.display = "block";
             const sortedNames = Array.from(previousNames).sort();
             sortedNames.forEach((name) => {
                const suggestionDiv = document.createElement("div"); suggestionDiv.textContent = name.charAt(0).toUpperCase() + name.slice(1);
                suggestionDiv.addEventListener("click", () => { nameInput.value = name.charAt(0).toUpperCase() + name.slice(1); nameSuggestions.style.display = "none"; checkFormValidity(); nameInput.focus(); });
                nameSuggestions.appendChild(suggestionDiv);
            });
        } else if (inputText.length > 0) { nameInput.dispatchEvent(new Event('input')); }
    });
    document.addEventListener("click", (e) => { if (!nameInput.contains(e.target) && !nameSuggestions.contains(e.target)) { nameSuggestions.style.display = "none"; } });
    // --- End Suggestions Logic ---

    // --- START: PDF Generation Code ---
    async function getImageBase64(url) {
        const fetchUrl = url;
        try {
            const response = await fetch(fetchUrl); if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
            const blob = await response.blob(); if (!blob.type.startsWith('image/')) { console.warn(`Workspaceed data is not an image type: ${blob.type}`); }
            return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(blob); });
        } catch (error) { console.error(`Could not fetch image ${url}:`, error); return null; }
    }

    async function generatePdf() {
        if (Object.keys(allEntriesData).length === 0) { alert("No data available to generate PDF."); return; }
        downloadPdfButton.textContent = "Generating PDF..."; downloadPdfButton.disabled = true; downloadCsvButton.disabled = true;
        const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        const pageHeight = doc.internal.pageSize.height; const pageWidth = doc.internal.pageSize.width; let yPos = 15; const margin = 10;
        const contentWidth = pageWidth - 2 * margin; const imageMaxHeight = 50; const imageMaxWidth = contentWidth / 2;
        const lineSpacing = 5; const entrySpacing = 8; const personSpacing = 12;

        doc.setFontSize(18); doc.text("Money Saving Tracker - Full Report", pageWidth / 2, yPos, { align: 'center' }); yPos += 8;
        doc.setFontSize(10); const generationDate = new Date().toLocaleString('en-LK', { timeZone: 'Asia/Colombo' }); doc.text(`Generated on: ${generationDate}`, pageWidth / 2, yPos, { align: 'center' }); yPos += 15;

        const names = Object.keys(allEntriesData).sort();
        for (const name of names) {
             const entries = allEntriesData[name]; const totalSaved = allSummaryData[name] || 0; const displayName = name.charAt(0).toUpperCase() + name.slice(1);
             if (yPos + 20 > pageHeight - margin) { doc.addPage(); yPos = 15; }
             doc.setFontSize(14); doc.setFont(undefined, 'bold'); const splitName = doc.splitTextToSize(displayName, contentWidth); doc.text(splitName, margin, yPos); yPos += (splitName.length * lineSpacing) + 2;
             doc.setFontSize(11); doc.setFont(undefined, 'normal'); doc.text(`Total Saved: LKR ${totalSaved.toFixed(2)}`, margin, yPos); yPos += lineSpacing * 2;

             for (const entry of entries) {
                  const entryDate = new Date(entry.timestamp).toLocaleString('en-LK', { timeZone: 'Asia/Colombo' }); const entryAmount = `LKR ${parseFloat(entry.amount).toFixed(2)}`;
                  const textLine1 = `Date: ${entryDate}`; const textLine2 = `Amount: ${entryAmount}`; const textHeight = lineSpacing * 2 + 2;
                  let imgBase64 = null; let finalImgHeight = 0; let finalImgWidth = 0; let imgErrorText = null; let imgFileType = 'JPEG';
                  if (entry.imageUrl) {
                      imgBase64 = await getImageBase64(entry.imageUrl);
                      if (imgBase64) { try { const imgProps = doc.getImageProperties(imgBase64); imgFileType = imgProps.fileType; let imgWidth = imgProps.width; let imgHeight = imgProps.height; const scale = Math.min(imageMaxWidth / imgWidth, imageMaxHeight / imgHeight, 1); finalImgWidth = imgWidth * scale; finalImgHeight = imgHeight * scale; } catch(e) { imgBase64 = null; imgErrorText = "(Error processing image)"; finalImgHeight = lineSpacing; } }
                      else { imgErrorText = "(Image could not be loaded)"; finalImgHeight = lineSpacing; } }
                  else { imgErrorText = "(No receipt image provided)"; finalImgHeight = lineSpacing; }
                  const requiredHeight = textHeight + finalImgHeight + entrySpacing; if (yPos + requiredHeight > pageHeight - margin) { doc.addPage(); yPos = 15; }
                  doc.setFontSize(10); doc.text(textLine1, margin, yPos); yPos += lineSpacing; doc.text(textLine2, margin, yPos); yPos += lineSpacing;
                  if (imgBase64) { try { doc.addImage(imgBase64, imgFileType, margin, yPos, finalImgWidth, finalImgHeight); yPos += finalImgHeight + lineSpacing / 2; } catch(e) { doc.setTextColor(255, 0, 0); doc.text("(Error adding image)", margin, yPos); doc.setTextColor(0, 0, 0); yPos += lineSpacing; } }
                  else if (imgErrorText) { doc.setTextColor(150, 150, 150); doc.setFontSize(9); doc.text(imgErrorText, margin, yPos); doc.setTextColor(0, 0, 0); doc.setFontSize(10); yPos += lineSpacing; }
                  yPos += entrySpacing - lineSpacing / 2;
             }
              yPos += personSpacing - entrySpacing;
        }

        // --- START: Add Footer to All Pages ---
        const pageCount = doc.internal.getNumberOfPages();
        const footerText = "</>Developed by Lakshan"; // Using the simplified text
        const footerY = pageHeight - 7; // Position 7mm from the bottom edge
        doc.setFontSize(8); doc.setTextColor(100, 100, 100);
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            try { // Right align
                const textWidth = doc.getStringUnitWidth(footerText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                const textX = pageWidth - margin - textWidth;
                doc.text(footerText, textX, footerY);
            } catch (e) { // Fallback to left align if width calculation fails
                console.warn("Could not calculate width for footer text, using left align.", e);
                doc.text(footerText, margin, footerY);
            }
        }
         doc.setFontSize(10); doc.setTextColor(0, 0, 0); // Reset font
        // --- END: Add Footer to All Pages ---

        try { doc.save(`money-saving-report-${Date.now()}.pdf`); }
        catch (e) { console.error("Error saving PDF:", e); alert("Failed to save the PDF."); }
        downloadPdfButton.textContent = "Download Report (PDF)";
        const hasData = allRawEntries.length > 0; downloadPdfButton.disabled = !hasData; downloadCsvButton.disabled = !hasData;
    }
    downloadPdfButton.addEventListener("click", generatePdf);
    // --- END: PDF Generation Code ---

    // --- START: CSV Generation Code ---
    function escapeCsvValue(value) { const stringValue = value === null || value === undefined ? '' : String(value); const escapedQuotes = stringValue.replace(/"/g, '""'); if (escapedQuotes.includes(',') || escapedQuotes.includes('"') || escapedQuotes.includes('\n')) { return `"${escapedQuotes}"`; } return escapedQuotes; }
    function generateCsv() {
        if (allRawEntries.length === 0) { alert("No data available to generate CSV."); return; }
        downloadCsvButton.textContent = "Generating CSV..."; downloadCsvButton.disabled = true; downloadPdfButton.disabled = true;
        const csvRows = []; const headers = ["Timestamp", "Date (Asia/Colombo)", "Name", "Amount (LKR)", "Image URL"]; csvRows.push(headers.map(escapeCsvValue).join(','));
        allRawEntries.forEach(entry => { const timestamp = entry.timestamp; const formattedDate = new Date(entry.timestamp).toLocaleString('en-LK', { timeZone: 'Asia/Colombo' }); const name = entry.name.charAt(0).toUpperCase() + entry.name.slice(1); const amount = (parseFloat(entry.amount) || 0).toFixed(2); const imageUrl = entry.imageUrl || ''; const row = [ timestamp, formattedDate, name, amount, imageUrl ]; csvRows.push(row.map(escapeCsvValue).join(',')); });
        const csvString = '\uFEFF' + csvRows.join('\n'); // Add BOM
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a");
        if (link.download !== undefined) { const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", `money-saving-data-${Date.now()}.csv`); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); }
        else { alert("CSV download via link generation is not supported in your browser."); }
        downloadCsvButton.textContent = "Download Data (CSV)"; const hasData = allRawEntries.length > 0; downloadPdfButton.disabled = !hasData; downloadCsvButton.disabled = !hasData;
    }
    downloadCsvButton.addEventListener("click", generateCsv);
    // --- END: CSV Generation Code ---

    // Initial load
    loadHistory();

  </script>
</body>
</html>
