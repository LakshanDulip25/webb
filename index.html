<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Saving Tracker | Lakshan</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS Variables --- */
        :root {
            /* Dark Theme (Default) */
            --bg-gradient-start: #0d1117; /* GitHub Dark Dimmed BG */
            --bg-gradient-end: #161b22;
            --text-primary: #c9d1d9; /* GitHub Dark Dimmed Text */
            --text-secondary: #8b949e; /* GitHub Dark Dimmed Secondary Text */
            --text-input: #c9d1d9; /* Match primary text */
            --accent-color: #58a6ff; /* GitHub Dark Dimmed Blue Accent */
            --accent-color-rgb: 88, 166, 255;
            --container-bg: #161b22; /* Match gradient end */
            --container-border: #30363d; /* GitHub Dark Dimmed Border */
            --container-bg-img-active: rgba(11, 25, 47, 0.75); /* Darker, more opaque for BG Img */
            --input-bg: #0d1117; /* Match gradient start */
            --input-border-focus: var(--accent-color);
            --button-primary-bg: linear-gradient(135deg, #238636, #2ea043); /* GitHub Green */
            /* --button-secondary-pdf-bg removed */
            --button-secondary-csv-bg: linear-gradient(135deg, #238636, #2ea043); /* GitHub Green */
            --button-secondary-wa-bg: linear-gradient(135deg, #25D366, #128C7E); /* Keep WA Green */
            --button-delete-bg: linear-gradient(135deg, #da3633, #f85149); /* GitHub Red */
            --button-text: white;
            --button-hover-brightness: 1.1;
            --table-header-bg: rgba(88, 166, 255, 0.1); /* Subtle accent bg */
            --table-row-hover: rgba(88, 166, 255, 0.07);
            --modal-bg: #161b22;
            --modal-text: var(--text-primary);
            --suggestions-bg: #21262d; /* Slightly lighter dark */
            --suggestions-text: var(--text-primary);
            --suggestions-border: var(--container-border);
            --suggestions-hover-bg: #30363d;
            --shadow-color-soft: rgba(0, 0, 0, 0.2); /* Softer shadows */
            --shadow-color-medium: rgba(0, 0, 0, 0.4);
            --scrollbar-thumb: #484f58; /* Grey scrollbar */
            --scrollbar-track: #21262d;
            --error-message: #f85149; /* GitHub Red */
            --error-message-rgb: 248, 81, 73;
            --backdrop-filter-val: none; /* No blur for this theme */
            --border-radius-sm: 6px; /* Consistent smaller radius */
            --border-radius-md: 8px;
            --border-radius-lg: 10px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }

        body.light-theme {
            /* Light Theme Refined */
            --bg-gradient-start: #f6f8fa; /* GitHub Light BG */
            --bg-gradient-end: #f6f8fa;
            --text-primary: #24292f; /* GitHub Light Text */
            --text-secondary: #57606a; /* GitHub Light Secondary */
            --text-input: #24292f;
            --accent-color: #0969da; /* GitHub Light Blue */
            --accent-color-rgb: 9, 105, 218;
            --container-bg: #ffffff;
            --container-border: #d0d7de; /* GitHub Light Border */
            --container-bg-img-active: rgba(255, 255, 255, 0.9); /* More opaque white */
            --input-bg: #ffffff; /* White inputs */
            --input-border-focus: var(--accent-color);
            --button-text: white;
            --button-hover-brightness: 1.05;
            --table-header-bg: #f6f8fa; /* Match body bg */
            --table-row-hover: #f0f3f6; /* Subtle hover */
            --modal-bg: #ffffff;
            --modal-text: var(--text-primary);
            --suggestions-bg: #ffffff;
            --suggestions-text: var(--text-primary);
            --suggestions-border: var(--container-border);
            --suggestions-hover-bg: var(--table-row-hover);
            --shadow-color-soft: rgba(140, 149, 159, 0.2); /* Subtle Grey Shadow */
            --shadow-color-medium: rgba(140, 149, 159, 0.3);
            --scrollbar-thumb: #adb5bd;
            --scrollbar-track: #f1f3f5;
            --error-message: #cf222e; /* GitHub Light Red */
            --error-message-rgb: 207, 34, 46;
            --backdrop-filter-val: none;
        }

        /* --- General Style Update --- */
        * { box-sizing: border-box; scroll-behavior: smooth; }
        html { font-size: 16px; }
        body, .login-container, .tracker-container form, .entry-card, .entry-card-deleted, table, .footer, input, button, .modal-content, .suggestions, .theme-toggle, .mute-toggle { transition: background-color 0.2s ease-in-out, background 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, backdrop-filter 0.2s ease-in-out, opacity 0.2s ease-in-out, transform 0.15s ease-in-out; }

        /* Base Body Styles */
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: var(--spacing-xl) var(--spacing-md); background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end)); background-attachment: fixed; color: var(--text-primary); display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; text-align: center; overflow-x: hidden; line-height: 1.6; }
        /* Background image toggle removed */

        /* --- Main Tracker Container Alignment --- */
        .tracker-container { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 1040px; margin: 0 auto; padding-bottom: 80px; display: none; }

        /* --- Containers & Cards --- */
        .login-container, .tracker-container form, .tracker-container .total-amount, .tracker-container .entry-card, .tracker-container .entry-card-deleted, .tracker-container table, .footer { background: var(--container-bg); border: 1px solid var(--container-border); box-shadow: 0 4px 12px -2px var(--shadow-color-soft); backdrop-filter: var(--backdrop-filter-val); border-radius: var(--border-radius-lg); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg); width: 90%; }
        .login-container, .tracker-container form, .tracker-container .total-amount, .download-buttons-container { max-width: 500px; }
        .tracker-container .history, .tracker-container table, .footer { max-width: 800px; }
        .tracker-container .history { padding: 0; background: none; border: none; box-shadow: none; backdrop-filter: none; margin-bottom: 0; margin-top: var(--spacing-lg); }
        .tracker-container form { padding: var(--spacing-lg); margin-bottom: var(--spacing-xl); position: relative; }
        .tracker-container .total-amount { padding: var(--spacing-md); margin-bottom: var(--spacing-lg); text-align: center; animation: pulse 2s infinite alternate; }
        .download-buttons-container { margin: 0 auto var(--spacing-xl) auto; }
        .tracker-container table { padding: 0; border-spacing: 0; overflow: hidden; margin-top: var(--spacing-lg); margin-bottom: var(--spacing-xl); border: 1px solid var(--container-border); box-shadow: 0 4px 12px -2px var(--shadow-color-soft); border-radius: var(--border-radius-lg);}
        .footer { padding: 15px 25px; margin-top: var(--spacing-xl); }
        /* BG Image active styles removed */

        /* --- Typography & Text --- */
        h1, h2 { font-weight: 600; margin-bottom: var(--spacing-md); text-shadow: none; }
        h1, h2 { color: var(--accent-color); }
        .tracker-container h1 { font-size: 2.2rem; margin-bottom: var(--spacing-lg); background: linear-gradient(90deg, var(--accent-color), var(--text-primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
        .tracker-container .history h2 { font-size: 1.6rem; margin-top: 0; margin-bottom: var(--spacing-lg); color: var(--text-primary); position: relative; display: inline-block; }
        .tracker-container .history h2:after { background: linear-gradient(90deg, transparent, var(--accent-color), transparent); height: 2px; bottom: -6px; content: ''; position: absolute; width: 50%; left: 25%; }
        .login-container h1 { font-size: 1.8rem; margin-bottom: var(--spacing-lg); }
        .tracker-container .total-amount { font-size: 1.3rem; font-weight: 500; color: var(--text-secondary); }
        .tracker-container .total-amount strong { font-size: 1.6rem; font-weight: 700; color: var(--accent-color); display: block; margin-top: var(--spacing-sm); }
        p { margin: var(--spacing-sm) 0; }
        a { color: var(--accent-color); text-decoration: none; }
        a:hover { filter: brightness(1.1); text-decoration: underline; }
        .footer { color: var(--text-secondary); }
        .footer a::after { display: none; }

        /* --- Forms & Inputs --- */
        .login-container input[type="password"], .tracker-container input[type="text"], .tracker-container input[type="number"] { background-color: var(--input-bg); color: var(--text-input); border: 1px solid var(--container-border); border-radius: var(--border-radius-md); padding: var(--spacing-md); font-size: 1rem; width: 100%; box-shadow: inset 0 1px 2px rgba(0,0,0,0.07); margin: 0; }
        .tracker-container form > div, .tracker-container form > input[type="number"] { margin-bottom: var(--spacing-md); width: 100%; }
        input:focus, input:focus-visible { outline: 2px solid transparent; border-color: var(--input-border-focus); box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.20); }
        .file-input-container { position: relative; overflow: hidden; }
        .file-input-label { background-color: transparent; color: var(--text-secondary); border: 2px dashed var(--container-border); border-radius: var(--border-radius-md); padding: var(--spacing-lg) var(--spacing-lg); font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .file-input-label:hover { border-color: var(--accent-color); color: var(--accent-color); background-color: rgba(var(--accent-color-rgb), 0.05); }
        .tracker-container input[type="file"] { position: absolute; top: 0; left: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .file-name { color: var(--text-secondary); margin-top: var(--spacing-sm); font-size: 0.9em;}
        #fileName:not(:empty):not(:contains('No file chosen')) { color: var(--accent-color); font-style: normal; font-weight: 500; }

        /* --- Buttons --- */
        button { font-family: 'Poppins', sans-serif; font-weight: 500; border-radius: var(--border-radius-md); padding: var(--spacing-sm) var(--spacing-lg); cursor: pointer; border: 1px solid transparent; transition: transform 0.15s ease, background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease, box-shadow 0.15s ease; font-size: 1rem; letter-spacing: 0.2px; text-transform: none; box-shadow: 0 1px 3px var(--shadow-color-soft); }
        button:hover:not(:disabled) { filter: brightness(var(--button-hover-brightness)); transform: translateY(-1px); box-shadow: 0 3px 8px var(--shadow-color-medium); }
        button:active:not(:disabled) { transform: translateY(0px); filter: brightness(0.95); box-shadow: 0 1px 3px var(--shadow-color-soft); }
        button:disabled { opacity: 0.65; cursor: not-allowed; background-image: none !important; background-color: var(--text-secondary) !important; color: var(--text-primary) !important; border-color: transparent !important; box-shadow: none !important; transform: none !important; }
        .login-container button, .tracker-container button[type="submit"] { background: var(--button-primary-bg); color: var(--button-text); border-color: transparent; width: 100%; margin-top: var(--spacing-lg); font-size: 1.05rem; padding: var(--spacing-md) var(--spacing-lg); text-transform: uppercase; font-weight: 600;}
        .tracker-container button[type="submit"] { opacity: 0.5; pointer-events: none; }
        .tracker-container button[type="submit"].enabled { opacity: 1; pointer-events: auto; }
        .download-buttons-container { display: flex; flex-direction: column; gap: var(--spacing-sm); width: 90%; max-width: 500px; margin: 0 auto var(--spacing-xl) auto; }
        @media (min-width: 500px) { .download-buttons-container { flex-direction: row; gap: var(--spacing-md);} }
        .download-button { color: var(--button-text); font-weight: 500; padding: var(--spacing-sm) var(--spacing-md); font-size: 0.9rem; flex: 1; border-color: transparent; }
        /* PDF Button Style Removed */
        .download-button.csv { background: var(--button-secondary-csv-bg); }
        .download-button.whatsapp { background: var(--button-secondary-wa-bg); }
        .modal-body .confirm-button { background: var(--button-secondary-wa-bg); }

        /* --- History / Entry Cards --- */
        #historyList { margin-top: var(--spacing-lg); }
        .tracker-container .entry-card, .tracker-container .entry-card-deleted { padding: var(--spacing-md); margin: 0 auto var(--spacing-md) auto; max-width: 100%; box-shadow: 0 3px 8px var(--shadow-color-soft); display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; }
        .tracker-container .entry-card:hover { box-shadow: 0 5px 15px var(--shadow-color-medium); transform: translateY(-2px); border-color: var(--accent-color); }
        .tracker-container .entry-card-info { padding-right: var(--spacing-md); flex-basis: calc(100% - 100px - var(--spacing-md)); flex-grow: 1;}
        .tracker-container .entry-card p { margin: var(--spacing-xs) 0; font-size: 0.9rem; line-height: 1.5; color: var(--text-secondary);}
        .tracker-container .entry-card-info p strong { color: var(--text-primary); }
        .tracker-container .entry-card-info p:first-child { font-weight: 600; color: var(--text-primary); font-size: 1rem; }
        .tracker-container .entry-card-info p:nth-child(2) { font-weight: 600; color: var(--accent-color);}
        .tracker-container .entry-card-info p:nth-child(3) { font-size: 0.85rem; }
        .tracker-container .entry-card-image-container { margin-left: var(--spacing-md); flex-basis: 70px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; }
        .tracker-container .entry-card img, .tracker-container .no-image-placeholder { width: 70px; height: 70px; border-radius: var(--border-radius-md); object-fit: cover; margin-bottom: var(--spacing-sm); }
        .tracker-container .no-image-placeholder { border-color: var(--container-border); color: var(--text-secondary); font-size: 0.8em; line-height: 70px; width: 70px; height: 70px;}
        .tracker-container .delete-button { background: var(--button-delete-bg); color: var(--button-text); border-radius: var(--border-radius-sm); padding: 2px 8px; font-size: 0.7rem; font-weight: 500; text-transform: uppercase; box-shadow: none; opacity: 0.7; margin-top: 0; border: none; }
        .tracker-container .entry-card:hover .delete-button { opacity: 1; }
        .tracker-container .delete-button:hover { opacity: 1; box-shadow: 0 1px 4px var(--shadow-color-soft); transform: none; filter: brightness(1.1); }
        .tracker-container .entry-card-deleted { opacity: 0.8; background: rgba(var(--error-message-rgb), 0.05); border-color: rgba(var(--error-message-rgb), 0.3); text-align: center; display: block; }
        .tracker-container .entry-card-deleted .original-details { border-bottom: 1px dashed rgba(var(--error-message-rgb), 0.3); opacity: 0.7; padding-bottom: var(--spacing-sm); margin-bottom: var(--spacing-sm); text-decoration: line-through; font-size: 0.9em; }
        .tracker-container .entry-card-deleted .original-details p, .tracker-container .entry-card-deleted .deletion-info p { text-align: center; margin: var(--spacing-xs) auto; }
        .tracker-container .entry-card-deleted .deletion-info { font-size: 0.9em; color: var(--text-secondary); margin-top: var(--spacing-sm); }
        .tracker-container .entry-card-deleted .deletion-info strong { color: var(--error-message); font-weight: 600; }

        /* --- Table Styles --- */
        .tracker-container table { border-collapse: separate; border-spacing: 0; }
        .tracker-container table th, .tracker-container table td { padding: var(--spacing-sm) var(--spacing-md); text-align: left; border-bottom: 1px solid var(--container-border); color: var(--text-primary); vertical-align: middle; }
        .tracker-container table th { background: var(--table-header-bg); font-weight: 600; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 1; color: var(--accent-color); border-bottom-width: 2px; border-bottom-color: var(--accent-color); }
        .tracker-container table tr:last-child td { border-bottom: none; }
        .tracker-container table tr:hover td { background-color: var(--table-row-hover); }
        .tracker-container table tr:nth-child(even) td { background-color: rgba(var(--accent-color-rgb), 0.02); }
        body.light-theme .tracker-container table tr:nth-child(even) td { background-color: #fbfcfd; }
        body.light-theme .tracker-container table tr:hover td { background-color: var(--table-row-hover); }
        .tracker-container table td:first-child { font-weight: 500; text-transform: capitalize; }
        .tracker-container table td:last-child { font-weight: 700; color: var(--accent-color); font-size: 1.05em; }

        /* --- Suggestions --- */
        .tracker-container .suggestions { top: calc(100% - 5px); border-radius: 0 0 var(--border-radius-md) var(--border-radius-md); border: 1px solid var(--suggestions-border); border-top: none; box-shadow: 0 10px 20px var(--shadow-color-soft); background: var(--suggestions-bg); color: var(--suggestions-text); z-index: 100; max-height: 200px; overflow-y: auto;}
        body.light-theme .tracker-container .suggestions { border-color: var(--container-border); }
        .tracker-container .suggestions div { padding: var(--spacing-sm) var(--spacing-lg); border-bottom: 1px solid var(--suggestions-border); color: var(--suggestions-text); text-align: left; cursor: pointer;}
        .tracker-container .suggestions div:hover { background: var(--suggestions-hover-bg); }
        .tracker-container .suggestions::-webkit-scrollbar { width: 6px; }
        .tracker-container .suggestions::-webkit-scrollbar-thumb { border-radius: 6px; border: none; background-color: var(--scrollbar-thumb); }
        .tracker-container .suggestions::-webkit-scrollbar-track { border-radius: 6px; background: var(--scrollbar-track); }

        /* --- Modals --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); animation: fadeIn 0.3s ease-out; display: flex; align-items: center; justify-content: center; padding: var(--spacing-md); }
        .modal-content { position: relative; border-radius: var(--border-radius-lg); border: 1px solid var(--container-border); box-shadow: 0 10px 30px var(--shadow-color-medium); background: var(--modal-bg); width: 90%; max-width: 500px; animation: slideInUp 0.4s ease-out; margin: 0; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { border-bottom: 1px solid var(--container-border); padding: var(--spacing-md) var(--spacing-lg); flex-shrink: 0; position: relative; }
        .modal-header h2 { font-size: 1.3rem; color: var(--accent-color); text-shadow: none; margin: 0;}
        .modal-header .close-button { position: absolute; top: 50%; right: var(--spacing-md); transform: translateY(-50%); font-size: 2rem; font-weight: normal; color: var(--text-secondary); cursor: pointer; line-height: 1; padding: 0; background: none; border: none; box-shadow: none; }
        .modal-header .close-button:hover { color: var(--error-message); }
        .modal-body { padding: var(--spacing-lg); font-size: 1rem; color: var(--modal-text); overflow-y: auto; flex-grow: 1; }
        .modal-body .confirm-button { font-size: 0.9rem; padding: var(--spacing-sm) var(--spacing-md); text-transform: none;}
        .modal-footer { border-top: 1px solid var(--container-border); padding: var(--spacing-sm) var(--spacing-lg); color: var(--text-secondary); font-size: 0.8rem; flex-shrink: 0; text-align: center; }
        #deleteConfirmModal input[type="text"], #whatsAppNumberModal input[type="tel"] { width: 100%; background-color: var(--input-bg); color: var(--text-input); border: 1px solid var(--container-border); border-radius: var(--border-radius-sm); padding: var(--spacing-sm); margin-bottom: var(--spacing-md); font-size: 0.95rem;}
        #deleteConfirmModal label, #whatsAppNumberModal label { display: block; margin-bottom: var(--spacing-sm); font-weight: 500; color: var(--text-secondary); text-align: left; font-size: 0.9rem;}
        #deleteConfirmModal .download-button, #whatsAppNumberModal .download-button { text-transform: uppercase; font-weight: 500;}
        #waNumberError { color: var(--error-message); font-size: 0.85em; min-height: 1.1em; margin-top: var(--spacing-xs); margin-bottom: var(--spacing-sm); text-align: left; }

        /* --- Control Buttons (Theme, Mute) --- */
        .mute-toggle, .theme-toggle { position: fixed; border-radius: var(--border-radius-md); width: 40px; height: 40px; font-size: 18px; background-color: var(--container-bg); color: var(--text-secondary); border: 1px solid var(--container-border); box-shadow: 0 2px 8px var(--shadow-color-soft); cursor: pointer; z-index: 101; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1; }
        .mute-toggle:hover, .theme-toggle:hover { color: var(--accent-color); border-color: var(--accent-color); background-color: var(--table-row-hover); transform: scale(1.05); }
        .mute-toggle { bottom: var(--spacing-md); right: var(--spacing-md); }
        .theme-toggle { top: var(--spacing-md); right: var(--spacing-md); }
        body.light-theme .mute-toggle, body.light-theme .theme-toggle { background-color: var(--container-bg); color: var(--text-secondary); border-color: var(--container-border); }
        body.light-theme .mute-toggle:hover, body.light-theme .theme-toggle:hover { color: var(--accent-color); border-color: var(--accent-color); background-color: var(--table-row-hover); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { from { box-shadow: 0 8px 25px -5px var(--shadow-color-soft); } to { box-shadow: 0 10px 30px -5px var(--accent-color); } }

        /* Responsive */
        @media (max-width: 600px) {
             body { padding: var(--spacing-lg) var(--spacing-sm); font-size: 15px;}
             .login-container, .tracker-container form, .tracker-container .total-amount, .tracker-container .entry-card, .tracker-container .entry-card-deleted, .tracker-container table, .footer { padding: var(--spacing-md); border-radius: var(--border-radius-md);}
             .tracker-container h1 { font-size: 1.8rem; }
             .tracker-container .history h2 { font-size: 1.4rem; }
             .tracker-container table th, .tracker-container table td { padding: var(--spacing-sm); font-size: 0.85rem; }
             .footer { padding: var(--spacing-sm) var(--spacing-md); font-size: 0.8rem;}
             .mute-toggle, .theme-toggle { width: 38px; height: 38px; font-size: 18px; }
             .mute-toggle { bottom: var(--spacing-sm); right: var(--spacing-sm); }
             .theme-toggle { top: var(--spacing-sm); right: var(--spacing-sm); }
             .tracker-container .entry-card { flex-direction: column; align-items: center; }
             .tracker-container .entry-card-info { padding-right: 0; margin-bottom: var(--spacing-sm); text-align: center; flex-basis: auto;}
             .tracker-container .entry-card-image-container { margin-left: 0; flex-basis: auto; width: 100%; align-items: center;}
             .tracker-container .entry-card img, .tracker-container .no-image-placeholder { margin-left: auto; margin-right: auto;}
             .download-buttons-container { flex-direction: column; gap: var(--spacing-sm); }
             .modal-content { width: 95%; max-height: 85vh;}
             .modal-body { padding: var(--spacing-md); }
        }

    </style>
</head>
<body class=""> <div class="login-container" id="loginSection">
        <h1>Enter Passcode</h1>
        <input type="password" id="passcodeInput" placeholder="Enter passcode" autocomplete="current-password">
        <button onclick="checkPasscode()">Enter Tracker</button>
        <p id="errorMessage"></p>
    </div>

    <div class="tracker-container" id="trackerSection">
        <h1>Money Saving Tracker</h1>
        <form id="trackerForm">
             <div style="position: relative;">
                 <input type="text" id="name" placeholder="Enter Name" required autocomplete="off" />
                 <div class="suggestions" id="nameSuggestions"></div>
             </div>
             <div class="file-input-container">
                 <label for="receiptImage" class="file-input-label">📸 Choose or Drag Receipt Image</label>
                 <input type="file" id="receiptImage" accept="image/*" required />
                 <div class="file-name" id="fileName">No file chosen</div>
             </div>
             <input type="number" id="amount" placeholder="Enter Amount (LKR)" required step="0.01" min="0"/>
             <button type="submit" id="submitButton" disabled>Submit Entry</button>
        </form>
        <div class="total-amount" id="totalAmount">Total Amount Saved:<strong>LKR 0.00</strong> </div>
        <div class="download-buttons-container">
            <button id="downloadCsvButton" class="download-button csv" disabled>Download CSV</button>
            <button id="sendWhatsAppButton" class="download-button whatsapp" disabled>Send via WA</button>
        </div>
        <div class="history">
            <h2>History</h2>
            <div id="historyList"> </div>
        </div>
        <table>
            <thead> <tr> <th>Name</th> <th>Total Savings (LKR)</th> </tr> </thead>
            <tbody id="summaryTable"> <tr><td colspan="2" style="text-align: center; font-style: italic; color: var(--text-secondary);">Loading data...</td></tr> </tbody>
        </table>
    </div>

    <div class="footer"> Current time in Sri Lanka: <span id="currentTime">Loading...</span><br> <a href="https://t.me/MrLAXAN" target="_blank">𝐃𝐞𝐯𝐞𝐥𝐨𝐩𝐞𝐝 𝐛𝐲 𝐋𝐚𝐤𝐬𝐡𝐚𝐧 🚀💻🔥</a> </div>

    <div id="successModal" class="modal"> <div class="modal-content"> <div class="modal-header"> <span class="close-button" id="closeSuccessModal">&times;</span> <h2>Success!</h2> </div> <div class="modal-body"> <p><span>✅</span>Record Submitted Successfully!</p> </div> <div class="modal-footer"> &lt;/&gt; Developed by Lakshan </div> </div> </div>
    <div id="whatsAppModal" class="modal"> <div class="modal-content"> <div class="modal-header"> <span class="close-button" id="closeWhatsAppModal">&times;</span> <h2>Confirm WhatsApp Send</h2> </div> <div class="modal-body"> <p>Ready to send the report to:</p> <p><strong id="whatsAppConfirmNumber"></strong></p> <button id="confirmWhatsAppSendButton" class="confirm-button">Open WhatsApp</button> </div> <div class="modal-footer"> &lt;/&gt; Developed by Lakshan </div> </div> </div>
    <div id="deleteConfirmModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span class="close-button" id="closeDeleteModal">&times;</span>
          <h2>Confirm Deletion</h2>
        </div>
        <div class="modal-body" style="text-align: left;">
          <p>Are you sure you want to mark this entry as deleted?</p>
          <p><strong id="deleteEntryDetails" style="color: var(--accent-color);"></strong></p>
          <hr style="border-color: var(--container-border); margin: var(--spacing-md) 0;">
          <label for="deleterNameInput">Your Name (Required):</label>
          <input type="text" id="deleterNameInput" placeholder="Enter your name">

          <label for="deletionReasonInput">Reason (Optional):</label>
          <input type="text" id="deletionReasonInput" placeholder="Reason for deletion">

          <div style="text-align: center; margin-top: var(--spacing-lg);">
             <button id="cancelDeleteButton" type="button" class="download-button" style="margin-right: var(--spacing-sm); background: var(--text-secondary);">Cancel</button>
             <button id="confirmDeleteButton" type="button" class="download-button delete-button" style="background: var(--button-delete-bg);">Confirm Delete</button>
          </div>
        </div>
        <div class="modal-footer">
           &lt;/&gt; Developed by Lakshan </div>
      </div>
    </div>
    <div id="whatsAppNumberModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <span class="close-button" id="closeWhatsAppNumberModal">&times;</span>
          <h2>Enter WhatsApp Number</h2>
        </div>
        <div class="modal-body" style="text-align: left;">
          <p>Please enter the recipient's WhatsApp number including the country code.</p>
          <label for="whatsAppNumberInput">WhatsApp Number:</label>
          <input type="tel" id="whatsAppNumberInput" placeholder="+94XXXXXXXXX" pattern="\+\d{8,}" required>
          <p id="waNumberError"></p> <div style="text-align: center; margin-top: var(--spacing-lg);">
             <button id="cancelWhatsAppNumberButton" type="button" class="download-button" style="margin-right: var(--spacing-sm); background: var(--text-secondary);">Cancel</button>
             <button id="confirmWhatsAppNumberButton" type="button" class="download-button whatsapp" style="background: var(--button-secondary-wa-bg);">Next</button>
          </div>
        </div>
        <div class="modal-footer">
           &lt;/&gt; Developed by Lakshan </div>
      </div>
    </div>


    <button id="theme-toggle-button" class="theme-toggle" title="Switch Theme">🌙</button>
    <button id="mute-button" class="mute-toggle" title="Mute Background Music">🔈</button>

    <audio id="background-audio" src="REPLACE_WITH_YOUR_MUSIC_URL.mp3" loop preload="auto">
      Your browser does not support the audio element.
    </audio>


    <script type="module">
        // Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js";

        // Globals
        let trackerInitialized = false;
        let database;
        let resetFormAndState = () => { console.warn("resetFormAndState called before tracker initialized"); };
        let markEntryAsDeletedFn = (timestamp, deleterName, deletionReason) => { console.error("markEntryAsDeletedFn called before init"); };
        let generateWhatsAppReportTextFn = () => { console.warn("generateWhatsAppReportTextFn called before init"); return "Report not ready."; };

        // --- DOM Ready Listener ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM loaded. Setting up initial state...");
            const initialLoginSection=document.getElementById('loginSection'); const initialTrackerSection=document.getElementById('trackerSection'); if(initialLoginSection)initialLoginSection.style.display='block'; if(initialTrackerSection)initialTrackerSection.style.display='none';
            const passcodeInputElem=document.getElementById('passcodeInput'); if(passcodeInputElem){passcodeInputElem.addEventListener('keypress',(event)=>{if(event.key==='Enter'){event.preventDefault();checkPasscode();}});}
            try{const t=document.getElementById('theme-toggle-button'),e=document.body,o=t=>{if(t){t.textContent=theme==='light'?'☀️':'🌙';t.title=theme==='light'?'Switch to Dark Theme':'Switch to Light Theme';}};const theme=localStorage.getItem('theme')||'dark';e.classList.toggle('light-theme',theme==='light');o(theme);console.log(`Applied theme: ${theme}`);if(t){t.addEventListener('click',()=>{e.classList.toggle('light-theme');const t=e.classList.contains('light-theme')?'light':'dark';localStorage.setItem('theme',t);o(t);console.log(`Switched theme: ${t}`);});}else console.error("Theme toggle button not found.");}catch(t){console.error("Theme setup error:",t);}
            /* BG Image Logic Removed */
            try{const t=document.getElementById('background-audio'),e=document.getElementById('mute-button');if(t&&e){const o=()=>{if(!t)return;if(t.muted){e.textContent='🔇';e.title='Unmute';}else{e.textContent='🔈';e.title='Mute';}};o();e.addEventListener('click',()=>{if(!t)return;t.muted=!t.muted;o();console.log(`Audio muted: ${t.muted}`);});console.log("Attempting audio autoplay...");t.play().then(()=>{console.log("Audio autoplay OK.");t.muted=false;o();}).catch(e=>{console.warn("Autoplay prevented:",e.message);o();const n=()=>{if(!t||!t.paused)return;t.play().then(()=>{console.log("Audio started via click.");o();}).catch(t=>console.error("Audio play on click error:",t));};console.log("Waiting user interaction for audio...");document.body.addEventListener('click',n,{once:true});document.body.addEventListener('touchstart',n,{once:true});});}else{if(!t)console.error("Audio element not found.");if(!e)console.error("Mute button not found.");}}catch(t){console.error("Audio setup error:",t);}
            console.log("Initial setup scripts run complete.");
        });

        // --- Passcode Check ---
        window.checkPasscode = function() {
            console.log("checkPasscode called");
            const correctPasscode = "0720";
            const passcodeInput = document.getElementById('passcodeInput');
            const errorMessage = document.getElementById('errorMessage');
            const loginSection = document.getElementById('loginSection');
            const trackerSection = document.getElementById('trackerSection');
            const enteredPasscode = passcodeInput ? passcodeInput.value : '';

            if (enteredPasscode === correctPasscode) {
                console.log("Passcode correct.");
                if(loginSection) loginSection.style.display = 'none';
                if(trackerSection) trackerSection.style.display = 'flex';
                if(errorMessage) errorMessage.textContent = '';

                if (!trackerInitialized) {
                    console.log("Initializing tracker...");
                    try {
                        initializeTracker();
                        trackerInitialized = true;
                        console.log("Tracker initialized successfully.");
                    } catch (initError) {
                        console.error("CRITICAL: Tracker initialization failed:", initError);
                        // **** Alert removed **** Show error inline instead.
                        if(errorMessage) errorMessage.textContent = 'Initialization failed. Check console (F12).';
                        if(loginSection) loginSection.style.display = 'block'; // Show login again
                        if(trackerSection) trackerSection.style.display = 'none';
                    }
                } else {
                    console.log("Tracker already initialized.");
                }
            } else {
                console.log("Incorrect passcode.");
                if(errorMessage) errorMessage.textContent = 'Incorrect passcode.';
                if (passcodeInput) { passcodeInput.value = ''; passcodeInput.focus(); }
                if(loginSection) loginSection.style.display = 'block';
                if(trackerSection) trackerSection.style.display = 'none';
            }
        }

        // --- Modal Controls ---
        const successModal=document.getElementById("successModal"),closeSuccessModalButton=document.getElementById("closeSuccessModal");function showSuccessModal(){if(successModal)successModal.style.display="flex"}function hideSuccessModal(){if(successModal)successModal.style.display="none";resetFormAndState()}if(closeSuccessModalButton)closeSuccessModalButton.onclick=hideSuccessModal;
        const whatsAppModal=document.getElementById("whatsAppModal"),closeWhatsAppModalButton=document.getElementById("closeWhatsAppModal"),whatsAppConfirmNumberSpan=document.getElementById("whatsAppConfirmNumber"),confirmWhatsAppSendButton=document.getElementById("confirmWhatsAppSendButton");function showWhatsAppModal(t,e){if(whatsAppConfirmNumberSpan)whatsAppConfirmNumberSpan.textContent=t;if(confirmWhatsAppSendButton)confirmWhatsAppSendButton.onclick=()=>{window.open(e,'_blank');hideWhatsAppModal();};if(whatsAppModal)whatsAppModal.style.display="flex"}function hideWhatsAppModal(){if(whatsAppModal)whatsAppModal.style.display="none";if(confirmWhatsAppSendButton)confirmWhatsAppSendButton.onclick=null}if(closeWhatsAppModalButton)closeWhatsAppModalButton.onclick=hideWhatsAppModal;
        const deleteConfirmModal=document.getElementById('deleteConfirmModal'),closeDeleteModalButton=document.getElementById('closeDeleteModal'),cancelDeleteButton=document.getElementById('cancelDeleteButton'),confirmDeleteButton=document.getElementById('confirmDeleteButton'),deleteEntryDetailsSpan=document.getElementById('deleteEntryDetails'),deleterNameInput=document.getElementById('deleterNameInput'),deletionReasonInput=document.getElementById('deletionReasonInput');function showDeleteConfirmModal(t,e){if(!deleteConfirmModal||!confirmDeleteButton)return;confirmDeleteButton.dataset.timestamp=t;if(deleteEntryDetailsSpan)deleteEntryDetailsSpan.textContent=e||'this entry';if(deleterNameInput)deleterNameInput.value='';if(deletionReasonInput)deletionReasonInput.value='';deleteConfirmModal.style.display='flex'}function hideDeleteConfirmModal(){if(!deleteConfirmModal||!confirmDeleteButton)return;delete confirmDeleteButton.dataset.timestamp;if(deleterNameInput)deleterNameInput.value='';if(deletionReasonInput)deletionReasonInput.value='';deleteConfirmModal.style.display='none'}if(closeDeleteModalButton)closeDeleteModalButton.onclick=hideDeleteConfirmModal;if(cancelDeleteButton)cancelDeleteButton.onclick=hideDeleteConfirmModal;
        if(confirmDeleteButton){confirmDeleteButton.onclick=()=>{const t=confirmDeleteButton.dataset.timestamp,e=deleterNameInput?deleterNameInput.value.trim():"",o=deletionReasonInput?deletionReasonInput.value.trim():"";if(!t){alert("Error: Timestamp missing.");hideDeleteConfirmModal();return}if(!e){alert("Your name is required.");if(deleterNameInput)deleterNameInput.focus();return}console.log(`Confirming delete: TS=${t}, By='${e}', Reason='${o||''}'`);markEntryAsDeletedFn(t,e,o);hideDeleteConfirmModal();}}else console.error("Confirm Delete Button not found");
        const whatsAppNumberModal=document.getElementById('whatsAppNumberModal'),closeWhatsAppNumberModalButton=document.getElementById('closeWhatsAppNumberModal'),cancelWhatsAppNumberButton=document.getElementById('cancelWhatsAppNumberButton'),confirmWhatsAppNumberButton=document.getElementById('confirmWhatsAppNumberButton'),whatsAppNumberInput=document.getElementById('whatsAppNumberInput'),waNumberError=document.getElementById('waNumberError');function showWhatsAppNumberModal(){if(!whatsAppNumberModal)return;if(whatsAppNumberInput)whatsAppNumberInput.value='';if(waNumberError)waNumberError.textContent='';whatsAppNumberModal.style.display='flex';if(whatsAppNumberInput)whatsAppNumberInput.focus()}function hideWhatsAppNumberModal(){if(!whatsAppNumberModal)return;if(waNumberError)waNumberError.textContent='';whatsAppNumberModal.style.display='none'}if(closeWhatsAppNumberModalButton)closeWhatsAppNumberModalButton.onclick=hideWhatsAppNumberModal;if(cancelWhatsAppNumberButton)cancelWhatsAppNumberButton.onclick=hideWhatsAppNumberModal;
        if(confirmWhatsAppNumberButton){confirmWhatsAppNumberButton.onclick=()=>{if(!whatsAppNumberInput||!waNumberError)return;const t=whatsAppNumberInput.value,e=t.replace(/\s+/g,""),o=/^\+\d{8,}$/;if(!o.test(e)){waNumberError.textContent="Invalid format. Use +CountryCodeNumber (e.g., +94771234567).";whatsAppNumberInput.focus();return}waNumberError.textContent="";hideWhatsAppNumberModal();console.log(`WA number entered: ${e}`);try{const t=generateWhatsAppReportTextFn(),o=encodeURIComponent(t),n=`https://api.whatsapp.com/send?phone=${e}&text=${o}`;console.log("Generated WA URL");showWhatsAppModal(e,n)}catch(t){console.error("WA Prep Err:",t);alert("Could not prep WA msg. Console.")}}}else console.error("Confirm WA Number Button not found");
        window.addEventListener('click',function(t){if(t.target==successModal)hideSuccessModal();else if(t.target==whatsAppModal)hideWhatsAppModal();else if(t.target==deleteConfirmModal)hideDeleteConfirmModal();else if(t.target==whatsAppNumberModal)hideWhatsAppNumberModal()});

        // --- Tracker Logic ---
        function initializeTracker() {
            console.log("Inside initializeTracker function.");
            // --- Config ---
            const firebaseConfig = { apiKey: "AIzaSyD1DbAbZ8yLeJxULV2giceFwzRFM6I-FF0", authDomain: "websavelxn.firebaseapp.com", databaseURL: "https://websavelxn-default-rtdb.firebaseio.com", projectId: "websavelxn", storageBucket: "websavelxn.firebasestorage.app", messagingSenderId: "781394117165", appId: "1:781394117165:web:cf042f7d5de2776222eea4" };
            const IMGBB_API_KEY = "c59fd4d2f34bb26b393faaf7affe501f";

            try { const app = initializeApp(firebaseConfig); database = getDatabase(app); console.log("Firebase initialized."); }
            catch (fbError) { console.error("Firebase Init Failed:", fbError); /* Alert Removed */ throw fbError; }

            // --- DOM Elements ---
            const trackerForm = document.getElementById("trackerForm"), historyList = document.getElementById("historyList"), submitButton = document.getElementById("submitButton"), totalAmountDisplay = document.getElementById("totalAmount"), summaryTable = document.getElementById("summaryTable"), nameInput = document.getElementById("name"), nameSuggestions = document.getElementById("nameSuggestions"), receiptImageInput = document.getElementById("receiptImage"), fileNameDisplay = document.getElementById("fileName"), /*pdf removed*/ downloadCsvButton = document.getElementById("downloadCsvButton"), sendWhatsAppButton = document.getElementById("sendWhatsAppButton"), currentTimeDisplay = document.getElementById("currentTime"), amountInput = document.getElementById("amount");

            // --- State ---
            let totalAmount = 0; const previousNames = new Set(); let allEntriesData = {}; let allSummaryData = {}; let allRawEntries = [];

            // --- Time Update ---
            function updateCurrentTime() { try { const now = new Date(); const options = { timeZone: 'Asia/Colombo', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }; if(currentTimeDisplay) currentTimeDisplay.textContent = now.toLocaleString('en-US', options); } catch (e) { console.error("Time update error:", e); if(currentTimeDisplay) currentTimeDisplay.textContent="Error"; } }
            updateCurrentTime(); const timeIntervalId = setInterval(updateCurrentTime, 1000);

            // --- Event Listeners ---
            if(receiptImageInput){receiptImageInput.addEventListener("change", function(){if(this.files&&this.files[0]){if(fileNameDisplay){fileNameDisplay.textContent=this.files[0].name;fileNameDisplay.style.color="var(--accent-color)";}}else{if(fileNameDisplay){fileNameDisplay.textContent="No file chosen";fileNameDisplay.style.color="var(--text-secondary)";}}checkFormValidity();});}else console.error("'receiptImage' not found.");
            if(trackerForm){trackerForm.addEventListener("submit", handleFormSubmit);trackerForm.addEventListener("input", (e)=>{if(e.target.id==='name'||e.target.id==='amount')checkFormValidity();});}else console.error("'trackerForm' not found.");
            if(nameInput){nameInput.addEventListener("input", handleNameInput);nameInput.addEventListener("focus", handleNameFocus);}else console.error("'nameInput' not found.");
            document.addEventListener("click", handleDocClickForSuggestions);
            /* PDF Listener removed */
            if(downloadCsvButton){downloadCsvButton.addEventListener("click", generateCsv);}else console.error("'downloadCsvButton' not found.");
            if(historyList){historyList.addEventListener('click', handleDeleteClick);}else console.error("'historyList' not found.");
            if(sendWhatsAppButton){sendWhatsAppButton.addEventListener('click', handleSendWhatsApp);}else console.error("'sendWhatsAppButton' not found.");

            // --- Core Functions ---
            async function uploadImage(file) { const t=new FormData;t.append("image",file);t.append("key",IMGBB_API_KEY);console.log("Uploading image...");try{const e=await fetch("https://api.imgbb.com/1/upload",{method:"POST",body:t}),o=await e.json();if(!e.ok||!o.success){const t=o.error?.message||`HTTP status ${e.status}`;throw new Error(`ImgBB upload failed: ${t}`)}console.log("ImgBB ok:",o.data.url);return o.data.url}catch(t){console.error("ImgBB Err:",t);alert(`Img upload fail: ${t.message}. Check console.`);throw t} }
            function saveEntry(name, imageUrl, amount) { if(!database){console.error("DB !ready save.");return Promise.reject("Database not ready")}const t=Date.now(),e=`entries/${t}`,o=ref(database,e),n={name:name.trim().toLowerCase(),imageUrl:imageUrl,amount:parseFloat(amount),timestamp:t,isDeleted:!1};console.log("Saving entry:",n);return set(o,n).then(()=>console.log("Save ok.")).catch(t=>{console.error("FB save error:",t);alert(`DB Save Fail: ${t.message}. Check rules/console.`);throw t}) }

            markEntryAsDeletedFn = (timestamp, deleterName, deletionReason) => { if (!database) { console.error("DB !ready delete mark."); alert("Err: DB conn fail."); return; } if (!timestamp || !deleterName) { console.error("Invalid data delete mark."); alert("Err: Missing info del."); return; } const entryRef = ref(database, `entries/${timestamp}`); const deletionData = { isDeleted: true, deletedBy: deleterName, deletionReason: deletionReason || '(No reason provided)', deletionTimestamp: Date.now() }; console.log(`Marking ${timestamp} deleted...`); update(entryRef, deletionData).then(() => console.log(`Marked ${timestamp} deleted.`)).catch((error) => { console.error(`Err mark ${timestamp} deleted:`, error); alert(`Fail mark deleted: ${error.message}`); }); };

            function loadHistory() { console.log("Setting up history listener..."); if (!database) { console.error("DB !init history."); return; } const entriesRef = ref(database, "entries"); onValue(entriesRef, (snapshot) => { console.log("History snapshot received."); if(historyList) historyList.innerHTML = ""; totalAmount = 0; const currentSummaryData = {}; const currentEntriesGroupedByName = {}; let currentRawEntries = []; previousNames.clear(); try { const entries = snapshot.val(); if (entries) { currentRawEntries = Object.entries(entries).map(([key, value]) => ({ ...value, firebaseKey: key })).filter(e => e && typeof e.name === 'string' && typeof e.timestamp === 'number' && typeof e.amount === 'number').sort((a, b) => b.timestamp - a.timestamp); console.log(`Processing ${currentRawEntries.length} history entries.`); currentRawEntries.forEach((entry, index) => { try { if (!entry.isDeleted) { const amountValue = parseFloat(entry.amount) || 0; totalAmount += amountValue; const name = entry.name.trim().toLowerCase(); previousNames.add(name); if (!currentSummaryData[name]) { currentSummaryData[name] = 0; currentEntriesGroupedByName[name] = []; } currentSummaryData[name] += amountValue; currentEntriesGroupedByName[name].push({ amount: amountValue, timestamp: entry.timestamp, imageUrl: entry.imageUrl || null }); } addEntryToHistory(entry); } catch (entryProcessingError) { console.error(`Error processing entry index ${index} (Timestamp: ${entry.timestamp || 'N/A'}):`, entryProcessingError, entry); if(historyList) { const errCard = document.createElement('div'); errCard.className='entry-card-deleted'; errCard.innerHTML = `<p style='color:var(--error-message);'>Err display entry (TS: ${entry.timestamp||'N/A'}). Console.</p>`; historyList.appendChild(errCard);} } }); } else { console.log("No entries in snapshot."); if(historyList) historyList.innerHTML = '<p>No history yet.</p>'; } allEntriesData = currentEntriesGroupedByName; allSummaryData = currentSummaryData; allRawEntries = currentRawEntries; console.log('loadHistory: Finished calculation. totalAmount =', totalAmount); if(totalAmountDisplay) totalAmountDisplay.innerHTML = `Total Amount Saved: <strong>LKR ${totalAmount.toFixed(2)}</strong>`; updateSummaryTable(allSummaryData); const hasActive = Object.keys(allSummaryData).length > 0; const hasAny = allRawEntries.length > 0; /* PDF Button Removed */ if(downloadCsvButton) downloadCsvButton.disabled = !hasAny; if(sendWhatsAppButton) sendWhatsAppButton.disabled = !hasActive; console.log("History processing done. Active Total:", totalAmount.toFixed(2)); } catch (snapErr) { console.error("Snapshot proc err:", snapErr); if(historyList) historyList.innerHTML = '<p style="color:var(--error-message);">Err proc history. Console.</p>'; if(totalAmountDisplay) totalAmountDisplay.innerHTML = `Total: <strong>LKR 0.00</strong>`; updateSummaryTable({}); console.error("Error processing history data. Check console (F12)."); /* Alert removed */ /* PDF Button Removed */ if(downloadCsvButton) downloadCsvButton.disabled=true; if(sendWhatsAppButton) sendWhatsAppButton.disabled=true; } }, (error) => { console.error("FB read err:", error); console.error(`Failed to load data from database: ${error.message}. Check Firebase rules, configuration, and console (F12).`); /* Alert removed */ allEntriesData={}; allSummaryData={}; allRawEntries=[]; if(historyList) historyList.innerHTML = `<p style="color:var(--error-message);">Err load history: ${error.message}.</p>`; if(totalAmountDisplay) totalAmountDisplay.innerHTML = `Total: <strong>LKR 0.00</strong>`; updateSummaryTable({}); /* PDF Button Removed */ if(downloadCsvButton) downloadCsvButton.disabled=true; if(sendWhatsAppButton) sendWhatsAppButton.disabled=true; }); }
            function addEntryToHistory(entry) { try { if(!historyList) return; if (!entry || typeof entry.name !== 'string' || typeof entry.amount !== 'number' || typeof entry.timestamp !== 'number') { console.warn("Skip history add: invalid data", entry); return; } const entryCard = document.createElement("div"); const displayName = entry.name.charAt(0).toUpperCase() + entry.name.slice(1); const entryAmount = (parseFloat(entry.amount) || 0).toFixed(2); const originalEntryDate = new Date(entry.timestamp).toLocaleString('en-LK', { timeZone: 'Asia/Colombo' }); if (entry.isDeleted) { entryCard.classList.add("entry-card-deleted"); entryCard.innerHTML = `<div class="original-details"><p><strong>Name:</strong> ${displayName}</p><p><strong>Amount:</strong> LKR ${entryAmount}</p><p><strong>Original Date:</strong> ${originalEntryDate}</p></div><div class="deletion-info"><p>Deleted by: <strong>${entry.deletedBy || 'Unknown'}</strong> on ${entry.deletionTimestamp ? new Date(entry.deletionTimestamp).toLocaleString('en-LK', { timeZone: 'Asia/Colombo' }) : 'N/A'}</p><p>Reason: <em>${entry.deletionReason ? String(entry.deletionReason).replace(/</g, "&lt;") : '(No reason provided)'}</em></p></div>`; } else { entryCard.classList.add("entry-card"); entryCard.innerHTML = `<div class="entry-card-info"><p><strong>Name:</strong> ${displayName}</p><p><strong>Amount:</strong> LKR ${entryAmount}</p><p><strong>Date:</strong> ${originalEntryDate}</p></div><div class="entry-card-image-container">${entry.imageUrl ? `<img src="${entry.imageUrl}" alt="Receipt" loading="lazy" onerror="this.parentElement.innerHTML = '<div class=\\'no-image-placeholder\\'>(Image Error)</div>';" />` : '<div class="no-image-placeholder">(No Image)</div>'}<button class="delete-button" data-timestamp="${entry.timestamp}" title="Mark deleted">Delete</button></div>`; } historyList.prepend(entryCard); requestAnimationFrame(()=>{entryCard.style.opacity="0";entryCard.style.transform="translateY(-20px)";requestAnimationFrame(()=>{entryCard.style.opacity="1";entryCard.style.transform="translateY(0)";});}); } catch (domError) { console.error("DOM Add Err:", domError, entry); } }
            function updateSummaryTable(summaryData) { try { if(!summaryTable) return; summaryTable.innerHTML = ""; const sortedNames = Object.keys(summaryData).sort((a, b) => a.localeCompare(b)); if (sortedNames.length === 0) { summaryTable.innerHTML = `<tr><td colspan="2" style="text-align:center;font-style:italic;color:var(--text-secondary);">No summary.</td></tr>`; } else { sortedNames.forEach(name => { const total = summaryData[name]; const row=document.createElement("tr"); const displayName=name.charAt(0).toUpperCase()+name.slice(1); const fmtTotal=(typeof total==='number'?total.toFixed(2):'Err'); row.innerHTML = `<td>${displayName}</td><td>LKR ${fmtTotal}</td>`; summaryTable.appendChild(row); }); } } catch (tableError) { console.error("Table Update Err:", tableError); if(summaryTable) summaryTable.innerHTML=`<tr><td colspan="2" style="text-align:center;color:var(--error-message);">Err loading summary. Console.</td></tr>`;} }
            function checkFormValidity() { try { if (!nameInput || !receiptImageInput || !amountInput || !submitButton) return; const name = nameInput.value.trim(); const receiptImage = receiptImageInput.files[0]; const amount = amountInput.value.trim(); const isValidAmount = amount !== '' && !isNaN(parseFloat(amount)) && parseFloat(amount) >= 0; const isValidName = name && !/\d/.test(name); const isFormValid = isValidName && receiptImage && isValidAmount; submitButton.classList.toggle('enabled', isFormValid); submitButton.disabled = !isFormValid; } catch (valErr) { console.error("Validation Check Err:", valErr); if(submitButton) {submitButton.classList.remove('enabled'); submitButton.disabled=true;} } }
            async function handleFormSubmit(e) { e.preventDefault(); if (!submitButton || submitButton.disabled) return; if (!nameInput || !receiptImageInput || !amountInput) return; const name = nameInput.value.trim(); const receiptImage = receiptImageInput.files[0]; const amount = amountInput.value.trim(); const isValidAmount = amount !== '' && !isNaN(parseFloat(amount)) && parseFloat(amount) >= 0; const isValidName = name && !/\d/.test(name); if (!isValidName || !receiptImage || !isValidAmount) { alert("Fill fields correctly:\n- Name (no numbers)\n- Image\n- Amount (>= 0)"); checkFormValidity(); return; } submitButton.innerHTML = "Saving..."; submitButton.disabled = true; submitButton.classList.remove('enabled'); try { console.log("Submitting..."); const imageUrl = await uploadImage(receiptImage); await saveEntry(name, imageUrl, amount); console.log("Submit OK."); showSuccessModal(); } catch (error) { console.error("Submit failed:", error); checkFormValidity(); } finally { if (submitButton.innerHTML === "Saving...") submitButton.innerHTML = "Submit Entry"; } }
            resetFormAndState = function() { console.log("Resetting form."); try { if(trackerForm) trackerForm.reset(); if(fileNameDisplay) { fileNameDisplay.textContent = "No file chosen"; fileNameDisplay.style.color = "var(--text-secondary)"; } if(nameSuggestions) nameSuggestions.style.display = 'none'; checkFormValidity(); } catch (resetError) { console.error("Reset Err:", resetError); } }
            function handleDeleteClick(event) { if (event.target.classList.contains('delete-button')) { const button = event.target; const timestampString = button.getAttribute('data-timestamp'); const entryCard = button.closest('.entry-card'); const nameElement = entryCard ? entryCard.querySelector('.entry-card-info p:first-child strong') : null; let entryNameText = 'this entry'; if (nameElement) { entryNameText = nameElement.textContent.trim(); } if (timestampString) { showDeleteConfirmModal(timestampString, entryNameText); console.log(`Delete clicked for ${entryNameText} (TS: ${timestampString}). Showing modal.`); } else { console.error("Delete button no timestamp.", button); alert("Error: Cannot delete, identifier missing."); } } }
            function handleNameInput() { if (!nameInput || !nameSuggestions) return; const inputText = nameInput.value.trim().toLowerCase(); nameSuggestions.innerHTML = ""; if (inputText.length > 0 && previousNames.size > 0) { const filteredNames = Array.from(previousNames).filter(name => name.toLowerCase().includes(inputText)).sort((a,b)=>a.localeCompare(b)); if (filteredNames.length > 0) { nameSuggestions.style.display = "block"; filteredNames.forEach((name) => { const div = document.createElement("div"); div.textContent = name.charAt(0).toUpperCase()+name.slice(1); div.onclick = () => { nameInput.value = name.charAt(0).toUpperCase()+name.slice(1); nameSuggestions.style.display = "none"; checkFormValidity(); nameInput.focus(); }; nameSuggestions.appendChild(div); }); } else { nameSuggestions.style.display = "none"; } } else { nameSuggestions.style.display = "none"; } }
            function handleNameFocus() { if (!nameInput || !nameSuggestions) return; const inputText = nameInput.value.trim().toLowerCase(); if (inputText.length === 0 && previousNames.size > 0) { nameSuggestions.innerHTML = ""; nameSuggestions.style.display = "block"; const sortedNames = Array.from(previousNames).sort((a,b)=>a.localeCompare(b)); sortedNames.forEach((name) => { const div = document.createElement("div"); div.textContent = name.charAt(0).toUpperCase()+name.slice(1); div.onclick = () => { nameInput.value = name.charAt(0).toUpperCase()+name.slice(1); nameSuggestions.style.display = "none"; checkFormValidity(); nameInput.focus(); }; nameSuggestions.appendChild(div); }); } else if (inputText.length > 0) { handleNameInput(); } }
            function handleDocClickForSuggestions(e) { if (!nameInput || !nameSuggestions) return; if (!nameInput.contains(e.target) && !nameSuggestions.contains(e.target)) { nameSuggestions.style.display = "none"; } }

            //** Assign actual WA report generator function to global reference **
            generateWhatsAppReportTextFn = () => {
                console.log("Generating WA text...");
                console.log('WhatsApp Report: Using totalAmount =', totalAmount); // Log value used
                // Helper to format date as [YY.Mon.DD]
                function formatDateForWA(timestamp) { if (!timestamp) return '[N/A]'; try { const d = new Date(timestamp); const yy = d.getFullYear().toString().slice(-2); const mon = d.toLocaleString('en-US', { month: 'short' }).charAt(0).toUpperCase() + d.toLocaleString('en-US', { month: 'short' }).slice(1); const dd = String(d.getDate()).padStart(2, '0'); return `[${yy}.${mon}.${dd}]`; } catch (e) { console.error("WA Date Format Error:", e); return '[Date Err]'; } }
                // Helper to format time as HH.MM.SS
                function formatTimeForWA(timestamp) { if (!timestamp) return 'N/A'; try { const d = new Date(timestamp); const hh = String(d.getHours()).padStart(2, '0'); const mm = String(d.getMinutes()).padStart(2, '0'); const ss = String(d.getSeconds()).padStart(2, '0'); return `${hh}.${mm}.${ss}`; } catch (e) { console.error("WA Time Format Error:", e); return 'Time Err'; } }

                // ** Refined check for total amount **
                let formattedTotal = "[Error]";
                if (typeof totalAmount === 'number' && isFinite(totalAmount)) { // Use isFinite
                    formattedTotal = totalAmount.toFixed(2);
                } else {
                    console.error("WhatsApp Report Error: totalAmount is not a valid finite number:", totalAmount);
                }

                let report = "____\n❝𝐓𝐑𝐀𝐂𝐊𝐄𝐑 𝐑𝐄𝐏𝐎𝐑𝐓❞\n____\n𝐒𝐚𝐯𝐞 𝐦𝐨𝐧𝐞𝐲, 𝐚𝐧𝐝 𝐦𝐨𝐧𝐞𝐲 𝐰𝐢𝐥𝐥 𝐬𝐚𝐯𝐞 𝐲𝐨𝐮❤️\n\n✅Total amount=> *LKR ${formattedTotal} 💰*\n\n"; // Use formattedTotal
                const sortedNames = Object.keys(allSummaryData).sort();

                if (sortedNames.length > 0) {
                    sortedNames.forEach(name => {
                        const dispName = name.charAt(0).toUpperCase() + name.slice(1);
                        const personTotal = allSummaryData[name].toFixed(2);
                        const entries = allEntriesData[name]; // Should contain only active entries, sorted newest first by loadHistory

                        report += `╭─── 🧙‍♂️:${dispName}\n |\n |   *🪙Total deposit:*\n |        •LKR ${personTotal} ⬇️\n`;

                        if (entries && entries.length > 0) {
                            entries.forEach((entry, index) => {
                                const entryDate = formatDateForWA(entry.timestamp);
                                const entryTime = formatTimeForWA(entry.timestamp);
                                const entryAmt = (parseFloat(entry.amount) || 0).toFixed(2);
                                if (index > 0) { report += ` |\n |-------------------------------×\n`; }
                                else { report += ` |\n`; } // Initial blank line
                                report += ` |   *📅Date ${entryDate}:*\n`;
                                report += ` |        •${entryTime}\n`;
                                report += ` |        •LKR ${entryAmt}\n`;
                            });
                        } else {
                            report += ` |\n |   (No deposit details found)\n`;
                        }
                        report += `╰───────────●●►\n\n`;
                    });
                } else {
                    report += "No savings recorded yet.\n\n";
                }
                report += "━━━━━━━━━━━━━━\n> </>𝙳𝚎𝚟𝚘𝚕𝚘𝚙𝚎𝚍 𝚋𝚢 𝙻𝚊𝚔𝚜𝚑𝚊𝚗🦊";
                return report;
            };

            //** Modified handleSendWhatsApp to show custom number input modal **
            function handleSendWhatsApp() { console.log("Send WhatsApp button clicked."); if (Object.keys(allSummaryData).length === 0 && totalAmount === 0) { alert("No data available to send."); return; } showWhatsAppNumberModal(); }

            // PDF Generation Functions Removed

            function generateCsv() { console.log("CSV gen start."); if(allRawEntries.length===0){alert("No data for CSV."); return;} if(downloadCsvButton){downloadCsvButton.textContent="Generating..."; downloadCsvButton.disabled=true;} /* PDF Button Removed */ if(sendWhatsAppButton)sendWhatsAppButton.disabled=true; try { const rows=[]; const headers=["TS (Unix)","Date (Local)","Name","Amount (LKR)","Image URL","Deleted","Deleted By","Del Reason","Del TS (Local)"]; rows.push(headers.map(escapeCsvValue).join(',')); allRawEntries.forEach(e=>{ const ts=e.timestamp||'', date=e.timestamp?new Date(e.timestamp).toLocaleString('en-LK',{timeZone:'Asia/Colombo'}):'', name=e.name?e.name.charAt(0).toUpperCase()+e.name.slice(1):'', amount=(parseFloat(e.amount)||0).toFixed(2), img=e.imageUrl||'', isDel=e.isDeleted?'Y':'N', delBy=e.deletedBy||'', delR=e.deletionReason||'', delTs=e.deletionTimestamp?new Date(e.deletionTimestamp).toLocaleString('en-LK',{timeZone:'Asia/Colombo'}):''; const row=[ts,date,name,amount,img,isDel,delBy,delR,delTs]; rows.push(row.map(escapeCsvValue).join(',')); }); const str='\uFEFF'+rows.join('\n'); const blob=new Blob([str],{type:'text/csv;charset=utf-8;'}); const link=document.createElement("a"); if(link.download!==undefined){ const url=URL.createObjectURL(blob); link.href=url; link.download=`money-saving-data-${Date.now()}.csv`; link.style.visibility='hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); console.log("CSV ok.");} else {alert("CSV dl !support.");}} catch(csvErr){console.error("CSV Gen Err:",csvErr); alert("Fail CSV gen. Console.");} finally{ const hasData=allRawEntries.length>0; const hasActive=Object.keys(allSummaryData).length>0; if(downloadCsvButton){downloadCsvButton.textContent="Download CSV"; downloadCsvButton.disabled=!hasData;} /* PDF Button Removed */ if(sendWhatsAppButton)sendWhatsAppButton.disabled=!hasActive;} }
            // getImageBase64 function removed
            function escapeCsvValue(v) { const s=v===null||v===undefined?'':String(v); const esc=s.replace(/"/g,'""'); if(esc.includes(',')||esc.includes('"')||esc.includes('\n')||esc.includes('\r')){return `"${esc}"`;} return esc; }

            // --- Initial Setup Calls ---
            console.log("Running initial setup inside initializeTracker.");
            loadHistory(); // Load initial data from Firebase
            checkFormValidity(); // Set initial state of submit button

        } // --- End of initializeTracker ---

    </script>

</body>
</html>
